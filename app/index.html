<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BONA BEETLE LITE</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BonaLite">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { bona: { black: '#0f0f0f', dark: '#1a1a1a', card: '#262626', gold: '#d4af37', text: '#e5e5e5', muted: '#a3a3a3', danger: '#ef4444', success: '#10b981' } } }
            }
        }
    </script>
    <style>
        html { height: 100%; overflow: hidden; background-color: #0f0f0f; }
        body { 
            height: 100%; width: 100%; margin: 0; padding: 0; 
            background-color: #0f0f0f; color: #e5e5e5; 
            overflow: hidden; overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        #app-container {
            display: flex; flex-direction: column;
            height: 100%; width: 100%; max-width: 480px;
            margin: 0 auto; position: relative; background-color: #0f0f0f;
        }

        .fixed-header-wrapper {
            position: absolute; top: 0; left: 0; right: 0; z-index: 50;
            background-color: rgba(15, 15, 15, 0.98);
            border-bottom: 1px solid #333;
            padding-top: max(env(safe-area-inset-top), 20px);
            min-height: 140px; 
            display: flex; flex-direction: column; justify-content: center;
        }
        .fixed-header-wrapper * { pointer-events: auto; }

        .detail-header {
            position: absolute; top: 0; left: 0; right: 0; 
            z-index: 60; 
            background-color: rgba(15, 15, 15, 0.98);
            border-bottom: 1px solid #333;
            padding-top: max(env(safe-area-inset-top), 15px);
            height: 90px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding-left: 1rem; padding-right: 1rem;
        }

        .dashboard-content {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding-top: 160px; 
            padding-bottom: 100px; 
            padding-left: 1rem; padding-right: 1rem;
        }
        
        .detail-content {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding-top: 110px; 
            padding-bottom: 120px; 
            padding-left: 1rem; padding-right: 1rem;
        }
        
        .fixed-bottom-wrapper {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 50;
            background-color: rgba(15, 15, 15, 0.95);
            border-top: 1px solid #333;
            padding: 1rem; padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        .dashboard-nav {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 100;
            background-color: rgba(15, 15, 15, 0.95);
            border-top: 1px solid #333;
            height: 80px; display: grid; grid-template-columns: repeat(3, 1fr);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; transition: all 0.3s; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        .nav-item.active-tab { color: #d4af37; }

        .gold-gradient { background: linear-gradient(135deg, #d4af37 0%, #a68a2e 100%); }
        .glass-panel { background: rgba(38, 38, 38, 0.9); border: 1px solid rgba(255, 255, 255, 0.1); }
        .loader { border: 4px solid #333; border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .quota-bar { transition: width 0.5s ease-out; }
        .lineage-link { color: #d4af37; text-decoration: underline; font-weight: bold; cursor: pointer; }
        .list-section { margin-bottom: 24px; }
        
        button { cursor: pointer; pointer-events: auto; }
        input, select { -webkit-appearance: none; background: #1a1a1a; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; }
        #reader { width: 100% !important; border: none !important; border-radius: 12px; overflow: hidden; }
        .upgrade-banner { background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, rgba(38, 38, 38, 0.9) 100%); border: 1px solid rgba(212, 175, 55, 0.2); }
    </style>
</head>
<body class="font-sans antialiased text-base">

    <!-- Global UI -->
    <div id="notification-area" class="fixed top-32 left-1/2 transform -translate-x-1/2 z-[300] w-11/12 max-sm space-y-2 pointer-events-none"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-black/90 z-[300] hidden flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-bona-gold text-lg font-bold tracking-wider animate-pulse">SYSTEM PROCESSING</p>
    </div>

    <!-- APP SHELL -->
    <div id="app-container">

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="flex h-full flex-col items-center justify-center p-6 z-10 relative">
            <div class="mb-8 text-center">
                <div class="w-24 h-24 mx-auto mb-4 bg-bona-dark rounded-full border-2 border-bona-gold flex items-center justify-center overflow-hidden shadow-lg shadow-bona-gold/20">
                     <img src="logo.png" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block';" class="w-full h-full object-cover">
                     <i class="fa-solid fa-bug text-4xl text-bona-gold hidden"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-widest text-center">BONA <span class="text-bona-gold">LITE</span></h1>
            </div>
            <div class="w-full glass-panel p-8 rounded-xl shadow-2xl space-y-6">
                <input type="text" id="login-license" class="w-full bg-bona-black border border-gray-700 text-white rounded-lg p-4 text-center font-mono text-lg" placeholder="輸入授權碼">
                <button onclick="window.handleLogin()" class="w-full gold-gradient text-black font-bold py-4 rounded-lg shadow-lg hover:brightness-110">驗證並登入</button>
            </div>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="hidden h-full flex-col relative">
            <header class="fixed-header-wrapper px-6">
                <div class="flex justify-between items-center mb-3 w-full px-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full border border-bona-gold flex items-center justify-center overflow-hidden">
                            <img src="logo.png" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block';" class="w-full h-full object-cover">
                            <i class="fa-solid fa-bug text-bona-gold text-[10px] hidden"></i>
                        </div>
                        <div class="flex flex-col"><span class="font-bold text-lg tracking-wide">BONA<span class="text-bona-gold">SYSTEMS</span></span><span class="text-[10px] text-gray-500 font-mono" id="dashboard-license-display">--</span></div>
                    </div>
                    <button onclick="window.logout()" class="text-bona-muted p-2"><i class="fa-solid fa-power-off text-lg"></i></button>
                </div>
                <div class="w-full px-5">
                    <div class="flex justify-between text-[10px] text-gray-400 mb-1">
                        <span>個體額度</span><span id="quota-text">-- / --</span>
                    </div>
                    <div class="bg-gray-800 rounded-full h-4 w-full border border-gray-700 overflow-hidden"><div id="quota-bar-fill" class="bg-bona-gold h-full" style="width: 0%;"></div></div>
                </div>
            </header>

            <main id="tab-home" class="dashboard-content">
                <div class="grid grid-cols-2 gap-5 mb-5 mt-4">
                    <button onclick="window.openScanner()" class="p-6 glass-panel rounded-xl flex flex-col items-center justify-center space-y-3"><i class="fa-solid fa-qrcode text-4xl text-bona-gold"></i><span class="text-sm font-bold">掃描 QR</span></button>
                    <button onclick="window.showNewEntryForm()" class="p-6 glass-panel rounded-xl flex flex-col items-center justify-center space-y-3"><i class="fa-solid fa-plus text-4xl text-gray-400"></i><span class="text-sm font-bold text-gray-400">新蟲錄入</span></button>
                </div>
                <div class="glass-panel p-6 rounded-xl space-y-4">
                    <h3 class="text-bona-gold text-xs font-bold uppercase tracking-widest border-b border-gray-800 pb-2">數據檢索</h3>
                    <div class="relative">
                        <input type="text" id="search-id" class="w-full bg-bona-black border border-gray-700 text-white rounded-lg p-4 font-mono text-lg" placeholder="輸入編號 (2401001)" oninput="this.value = this.value.toUpperCase()">
                        <button onclick="window.handleManualSearch()" class="absolute right-2 top-2 bottom-2 w-12 bg-bona-card rounded-md text-bona-gold"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
            </main>

            <main id="tab-butler" class="dashboard-content hidden">
                <div class="flex justify-between items-end mb-6 mt-4">
                    <h3 class="text-white text-xl font-bold">換土工作單</h3>
                    <button onclick="window.refreshTaskButler()" class="text-bona-gold p-2"><i class="fa-solid fa-rotate"></i></button>
                </div>
                <div id="section-overdue" class="list-section hidden"><h4 class="text-bona-danger text-xs font-bold mb-3 uppercase">已逾期 (Overdue)</h4><div id="list-overdue" class="space-y-3"></div></div>
                <div id="section-warning" class="list-section hidden"><h4 class="text-bona-gold text-xs font-bold mb-3 uppercase">警示 (Urgent - 14D)</h4><div id="list-warning" class="space-y-3"></div></div>
                <div id="section-safe" class="list-section hidden"><h4 class="text-bona-success text-xs font-bold mb-3 uppercase">安全 (Safe)</h4><div id="list-safe" class="space-y-3"></div></div>
                <div id="butler-empty" class="hidden text-center py-20 opacity-20"><p>目前無待處理任務</p></div>
            </main>

            <nav class="dashboard-nav">
                <button onclick="window.switchDashTab('home')" id="nav-home" class="nav-item active-tab"><i class="fa-solid fa-house-chimney mb-1"></i><span>錄入</span></button>
                <button onclick="window.switchDashTab('butler')" id="nav-butler" class="nav-item"><i class="fa-solid fa-calendar-check mb-1"></i><span>管家</span></button>
                <button onclick="window.switchDashTab('asset')" id="nav-asset" class="nav-item"><i class="fa-solid fa-user-gear mb-1"></i><span>我的</span></button>
            </nav>
        </div>

        <!-- VIEW: DETAIL -->
        <div id="view-detail" class="hidden h-full flex-col relative">
            <header class="detail-header">
                <button onclick="window.showDashboard()" class="text-gray-400 p-4"><i class="fa-solid fa-arrow-left text-2xl"></i></button>
                <span class="font-bold text-lg text-bona-gold" id="detail-header-id">--</span>
                <button onclick="window.showQRCodeForCurrent()" class="text-bona-gold p-2"><i class="fa-solid fa-qrcode text-xl"></i></button>
            </header>
            <main class="detail-content space-y-4">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-bona-gold">
                    <div class="text-3xl font-bold text-white font-mono mb-2" id="d-id">--</div>
                    <div class="flex space-x-6 text-sm text-gray-400">
                        <span>累代: <span id="d-gen">--</span></span><span>孵化: <span id="d-hatch">--</span></span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-bona-card p-4 rounded-xl border border-gray-800"><div class="text-xs text-gray-500 mb-1">目前體重</div><div class="text-3xl font-bold text-white"><span id="d-weight">--</span>g</div></div>
                    <div class="bg-bona-card p-4 rounded-xl border border-gray-800"><div class="text-xs text-gray-500 mb-1">最後量測</div><div class="text-lg font-bold text-white" id="d-check">--</div></div>
                </div>
                <div class="glass-panel p-4 rounded-xl">
                    <h3 class="text-bona-gold text-xs font-bold uppercase mb-3 border-b border-gray-800 pb-2">血統資訊</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><div class="text-gray-500">父代</div><div id="d-sire">--</div></div>
                        <div><div class="text-gray-500">母代</div><div id="d-dam">--</div></div>
                    </div>
                </div>
                <div id="history-section" class="hidden space-y-3"><h3 class="text-xs text-bona-muted font-bold pl-1 uppercase">歷史紀錄</h3><div id="history-list"></div></div>
            </main>
            <div class="fixed-bottom-wrapper"><button onclick="window.openUpdateModal()" class="w-full bg-white text-black font-bold py-4 rounded-lg uppercase text-lg">記錄成長數據</button></div>
        </div>

        <!-- MODALS -->
        <div id="modal-update" class="hidden fixed inset-0 z-[150] bg-black/90 flex items-center justify-center p-4">
            <div class="bg-bona-card w-full max-w-sm rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-bona-gold mb-6 border-b border-gray-800 pb-4">更新數據</h3>
                <form onsubmit="window.handleUpdateSubmit(event)" class="space-y-6">
                    <input type="hidden" id="update-id">
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs text-gray-500">記錄日期</label><input type="date" id="update-date" required></div>
                        <div><label class="text-xs text-gray-500">體重 (g)</label><input type="number" step="0.1" id="update-weight" required></div>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs text-gray-500">容器</label><select id="update-box-type"><option value="Keep">維持不變</option><option value="布丁杯">布丁杯</option><option value="塑膠圓罐">塑膠圓罐</option><option value="日規雙孔罐">日規雙孔罐</option></select></div>
                        <div><label class="text-xs text-gray-500">容量</label><select id="update-box-vol"><option value="Keep">維持不變</option><option value="500ml">500ml</option><option value="1000ml">1000ml</option><option value="1400ml">1400ml</option></select></div>
                    </div>
                    <div class="space-y-4">
                        <label class="text-xs text-gray-500">更換食材</label>
                        <select id="update-sub"><option value="Keep">維持不變</option><option value="BONA木屑">BONA木屑</option><option value="小糕菌">小糕菌</option><option value="廢木屑">廢木屑</option></select>
                    </div>
                    <div class="flex space-x-3">
                        <button type="button" onclick="window.closeUpdateModal()" class="flex-1 bg-gray-800 text-white py-4 rounded-lg">取消</button>
                        <button type="submit" class="flex-2 gold-gradient text-black font-bold py-4 rounded-lg flex-[2]">確認更新</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modal-new-entry" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-bona-card w-full max-w-sm rounded-xl p-6 border border-gray-700 my-8">
                <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 pb-4">新蟲 <span class="text-bona-gold">錄入</span></h3>
                <form id="form-new-entry" onsubmit="window.handleNewEntrySubmit(event)" class="space-y-4">
                    <div class="bg-gray-900 p-4 rounded-lg border border-gray-700">
                        <input type="text" id="id-prefix" class="w-full bg-black border border-bona-gold text-white text-3xl p-2 text-center font-bold" value="D" oninput="window.updateIDPreview()">
                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <select id="id-year" onchange="window.updateIDPreview()"><option value="24">24</option><option value="25">25</option></select>
                            <input type="number" id="id-batch" value="01" oninput="window.updateIDPreview()">
                            <input type="number" id="id-seq" value="001" oninput="window.updateIDPreview()">
                        </div>
                        <div class="text-center font-mono text-lg text-white mt-2" id="id-preview">--</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-gray-500">孵化日</label><input type="date" id="new-hatch-date" required></div>
                        <div><label class="text-xs text-gray-500">初始重</label><input type="number" step="0.1" id="new-weight" required></div>
                    </div>
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="window.closeNewEntryModal()" class="flex-1 bg-gray-800 text-white py-4 rounded-lg">取消</button>
                        <button type="submit" class="flex-2 gold-gradient text-black font-bold py-4 rounded-lg flex-[2]">確認錄入</button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <script>
        const WEBHOOK_URL = "https://hook.us2.make.com/dft05gnm8d1nnhq1uw9owyy5rbon904w"; 
        const API_KEY = "BonaPro-Safe-19790514"; 
        
        let currentUser = localStorage.getItem('bona_user_key') || null;
        let currentRealId = localStorage.getItem('bona_user_id') || null;
        let quotaInfo = { max: 50, used: 0 }; 
        let currentDetailData = null;

        async function secureFetch(payload) {
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-make-apikey': API_KEY 
                },
                body: JSON.stringify(payload)
            });
            const text = await response.text();
            if (text.trim() === "Accepted") return { status: "success", message: "Accepted" };
            try {
                return JSON.parse(text);
            } catch (e) {
                if (response.ok) return { status: "success", raw: text };
                throw new Error("伺服器回應異常，請檢查網路或授權");
            }
        }

        window.getDomVal = function(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        window.cleanData = function(val) {
            if (val === null || val === undefined) return '--';
            if (typeof val === 'object') {
                if (val.plain_text) return val.plain_text;
                if (val.select) return val.select.name;
                if (val.number !== undefined) return val.number;
                if (val.date) return val.date.start.split('T')[0];
            }
            return val;
        }

        window.showLoading = function(show) { document.getElementById('loading-overlay').classList[show ? 'remove' : 'add']('hidden'); if(show) document.getElementById('loading-overlay').classList.add('flex'); }
        window.showNotification = function(msg, type) { const area = document.getElementById('notification-area'); const el = document.createElement('div'); el.className = `${type === 'success' ? 'bg-green-600' : 'bg-red-600'} text-white px-4 py-3 rounded shadow-lg text-sm font-bold flex items-center justify-center`; el.innerText = msg; area.appendChild(el); setTimeout(() => el.remove(), 3000); }
        
        window.switchView = function(viewName) { 
            ['view-login', 'view-dashboard', 'view-detail'].forEach(id => document.getElementById(id).classList.add('hidden')); 
            const target = document.getElementById(`view-${viewName}`); 
            if (target) { target.classList.remove('hidden'); target.classList.add('flex'); }
        }

        window.switchDashTab = function(tab) {
            document.querySelectorAll('.dashboard-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`tab-${tab}`)?.classList.remove('hidden');
            document.getElementById(`nav-${tab}`)?.classList.add('active-tab');
            if (tab === 'butler') window.refreshTaskButler();
        }

        window.verifyLicense = async function(key, silent) { 
            if (!silent) window.showLoading(true); 
            try { 
                let data = await secureFetch({ type: 'auth', userId: key });
                if (data.json) data = JSON.parse(data.json);
                if (Array.isArray(data)) data = data[0]; 

                const cleanKey = window.cleanData(data.key_found || data.id); 
                const cleanStatus = window.cleanData(data.status || data.Status).toString().toLowerCase(); 

                if (cleanKey === key && cleanStatus.includes('active')) { 
                    currentUser = key; 
                    currentRealId = window.cleanData(data.real_id || data.user_id || data.id); 
                    localStorage.setItem('bona_user_key', key); localStorage.setItem('bona_user_id', currentRealId); 
                    quotaInfo = { max: parseInt(data.max) || 50, used: parseInt(data.used) || 0 }; 
                    window.updateDashboardUI(); 
                    if (!silent) window.switchView('dashboard'); 
                } else { if (!silent) window.showNotification('無效授權', 'error'); else window.logout(); } 
            } catch(e) { if(!silent) window.showNotification(`連線出錯`, 'error'); } finally { window.showLoading(false); } 
        }

        window.fetchBeetleData = async function(id) { 
            window.showLoading(true); 
            try { 
                let data = await secureFetch({ type: 'query', id: id, userId: currentRealId || currentUser });
                if (data.json) data = typeof data.json === 'string' ? JSON.parse(data.json) : data.json; 
                let items = Array.isArray(data) ? data : (data.data || data.items || [data]);
                const history = items.map(obj => { const n = {}; Object.keys(obj).forEach(k => n[k.toLowerCase()] = obj[k]); return n; }).filter(i => i.id);
                if (history.length > 0) { 
                    history.sort((a, b) => new Date(b.date_check || 0) - new Date(a.date_check || 0));
                    currentDetailData = history[0]; 
                    window.populateDetailView(currentDetailData); 
                    window.renderHistoryList(history); 
                    window.switchView('detail'); 
                } else { window.showNotification('找不到紀錄', 'error'); } 
            } catch (e) { window.showNotification(`查詢失敗`, 'error'); } finally { window.showLoading(false); } 
        }

        window.handleNewEntrySubmit = async function(e) {
            e.preventDefault();
            if (!currentUser) return;
            window.showLoading(true);
            try {
                const fullId = window.updateIDPreview();
                const payload = {
                    type: 'growth',
                    mode: 'new',
                    id: fullId,
                    userId: currentRealId || currentUser,
                    date_check: new Date().toISOString().split('T')[0],
                    date_hatch: window.getDomVal('new-hatch-date'),
                    weight: parseFloat(window.getDomVal('new-weight')) || 0,
                    generation: 'CBF1', 
                    status: 'Larva'
                };
                
                await secureFetch(payload);
                window.showNotification('錄入成功', 'success');
                window.closeNewEntryModal();
                setTimeout(() => window.fetchBeetleData(fullId), 1500);
            } catch (error) {
                window.showNotification('錄入失敗，請檢查欄位', 'error');
            } finally { window.showLoading(false); }
        }

        window.handleUpdateSubmit = async function(e) {
            e.preventDefault();
            window.showLoading(true);
            try {
                const id = window.getDomVal('update-id');
                const payload = {
                    type: 'growth',
                    mode: 'update',
                    id: id,
                    userId: currentRealId || currentUser,
                    weight: parseFloat(window.getDomVal('update-weight')) || 0,
                    date_check: window.getDomVal('update-date'),
                    sub_main: window.getDomVal('update-sub') === 'Keep' ? null : window.getDomVal('update-sub')
                };
                await secureFetch(payload);
                window.showNotification('更新成功', 'success');
                window.closeUpdateModal();
                setTimeout(() => window.fetchBeetleData(id), 1500);
            } catch (e) {
                window.showNotification('更新失敗', 'error');
            } finally { window.showLoading(false); }
        }

        window.refreshTaskButler = async function() {
            window.showLoading(true);
            try {
                let d = await secureFetch({ type: 'census', userId: currentRealId || currentUser });
                let rawData = d.items || d.data || d;
                const items = Array.isArray(rawData) ? rawData : [rawData];
                const list = document.getElementById('list-overdue');
                list.innerHTML = '';
                items.forEach(raw => {
                    const i = {}; Object.keys(raw).forEach(k => i[k.toLowerCase()] = raw[k]);
                    if(i.id) list.innerHTML += `<div class="glass-panel p-4 rounded-xl border-l-4 border-bona-gold mb-2" onclick="window.fetchBeetleData('${i.id}')">${i.id}</div>`;
                });
                document.getElementById('section-overdue').classList.remove('hidden');
            } catch(e) { window.showNotification("同步失敗", 'error'); } finally { window.showLoading(false); }
        }

        window.updateIDPreview = function() {
            const id = `${window.getDomVal('id-prefix')}-${window.getDomVal('id-year')}-${window.getDomVal('id-batch').padStart(2,'0')}-${window.getDomVal('id-seq').padStart(3,'0')}`;
            document.getElementById('id-preview').innerText = id;
            return id;
        }

        window.updateDashboardUI = function() {
            document.getElementById('dashboard-license-display').innerText = `LIC: ${currentUser.substring(0,4)}...`;
            document.getElementById('quota-text').innerText = `${quotaInfo.used} / ${quotaInfo.max}`;
            document.getElementById('quota-bar-fill').style.width = `${(quotaInfo.used / quotaInfo.max) * 100}%`;
        }

        window.logout = function() { localStorage.clear(); location.reload(); }
        window.handleManualSearch = function() { const id = document.getElementById('search-id').value; if(id) window.fetchBeetleData(id); }
        window.populateDetailView = function(d) {
            document.getElementById('detail-header-id').innerText = window.cleanData(d.id);
            document.getElementById('d-id').innerText = window.cleanData(d.id);
            document.getElementById('d-gen').innerText = window.cleanData(d.generation);
            document.getElementById('d-hatch').innerText = window.cleanData(d.date_hatch);
            document.getElementById('d-weight').innerText = window.cleanData(d.weight);
            document.getElementById('d-check').innerText = window.cleanData(d.date_check);
            document.getElementById('update-id').value = window.cleanData(d.id);
        }
        window.renderHistoryList = function(arr) {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            document.getElementById('history-section').classList.remove('hidden');
            arr.forEach(i => {
                list.innerHTML += `<div class="glass-panel p-4 rounded-xl mb-2 flex justify-between"><span>${window.cleanData(i.date_check)}</span><span class="text-bona-gold">${window.cleanData(i.weight)}g</span></div>`;
            });
        }
        window.showNewEntryForm = function() { document.getElementById('modal-new-entry').classList.remove('hidden'); window.updateIDPreview(); }
        window.closeNewEntryModal = function() { document.getElementById('modal-new-entry').classList.add('hidden'); }
        window.openUpdateModal = function() { document.getElementById('modal-update').classList.remove('hidden'); }
        window.closeUpdateModal = function() { document.getElementById('modal-update').classList.add('hidden'); }
        window.createLineageLink = function(v) { return v; }
        window.showQRCodeForCurrent = function() { window.showNotification('QR Code 功能升級中', 'success'); }

        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) window.verifyLicense(currentUser, true); else window.switchView('login');
        });
    </script>
</body>
</html>